![Screenshot from 2024-03-08 14-58-54](https://github.com/akostrik/general-culture/assets/22834202/21c2e1af-1da8-441b-ae20-47201cf09d5e)

* nginx = **веб-сервер** (**HTTP-сервер**)
  + обрабатывает запросы от клиентов по протоколам HTTP и HTTPS
  + возвращает ответ в виде HTML-страницы
  + сайт = набор файлов, они пересылаются веб-сервером пользователю
* nginx = **прокси-сервер** принимает и обрабатывает запросы клиентов, передает их другим программам
  + SSL/TLS-терминация: Nginx поддерживает оба протокола, обеспечивая шифрование и дешифрование данных, поэтому его можно использовать в качестве посредника между клиентом и основным веб-сервером, снижая нагрузку на последний
* nginx = **обратный прокси-сервер** принимает результат работы других серверов, отдаёт его клиентам
* nginx = **SMTP/IMAP/POP3-прокси сервер** (**почтовый прокси-сервер**)
  + перенаправление пользователя на SMTP/IMAP/POP3-бэкенд
  + внешний HTTP-сервер аутентификации
  + поддержка SSL, STARTTLS
* nginx = **балансировщик нагрузки** распределяет сетевые запросы между серверами
* простой, не перегруженный функциями
* быстрый, нет проседания под нагрузкой, распределение нагрузки на серверную часть
* отказоустойчивость
* безопасность
* usage
  + большое количество запросов одновременно
  + обслуживание неизменяемых запросов
  + обслуживание индексных файлов
  + лидер по скорости обработки статического контента, который одинаков для всех пользователей (карточки товаров в онлайн-магазине, лендинги, новостные сайты)
  + кеширование и стриминг видео
  + построение CDN-сетей
  + хостинг нескольких сайтов на одном сервере
* как устроен
  + асинхронная архитектура, запросы обрабатываются на разных этапах -> скорость (до него  запросы каждого пользователя обрабатывались по отдельности, требовалось много процессов и всё работало медленнее)
  + событийно-ориентированная обработка запросов => множество соединений без блокирования ввода и вывода, масштабироваться до сотен тысяч параллельных соединений, обрабатывает множество соединений в одном процессе
  + параллельно несколько подзапросов на одной странице, обрабатываемых в SSI-фильтре через прокси или FastCGI
  + рабочие процессы выполняют цикл обработки событий от дескрипторов
  + 10,000 одновременных запросов
  + до 1024 запросов на одно сетевое соединение
  + минимум памяти + производительность
  + простое распределение нагрузки
  + **Пул** = последовательность выделенных блоков динамической памяти. Если размер объекта превышает значение NGX_MAX_ALLOC_FROM_POOL либо длину блока, то он полностью выделяется из кучи
    - => мелкие объекты выделяются быстро 
  + фиксированное число процессов => максимально эффективно использовать ресурсы сервера, оперативную память
  + запросы от пользователя разбиваются на маленькие структуры — сетевые соединения
  + разобранный запрос последовательно обрабатывается цепочкой модулей
  + после обработки соединения собираются в одном виртуальном контейнере, чтобы преобразоваться в единый первоначальный запрос, затем отправляются пользователю
  + ответ клиенту формируется в буферах, буфера объединяются в цепочки, в этой последовательности передаются клиенту
  + автоматическое создание списка файлов, кэш дескрипторов открытых файлов
  + акселерированное проксирование без кэширования
  + поддержка кеширования при акселерированном проксировании и FastCGI
  + акселерированная поддержка FastCGI и memcached-серверов
  + фильтры: сжатие (gzip), byte-ranges (докачка), chunked-ответы, HTTP-аутентификация, SSI-фильтр
  + эффективные операции ввода-вывода (writev, sendfile)
  + поддержка SSL, PSGI, WSGI, экспериментально встроенного Perl
  + модуль географической классификации клиентов по IP-адресу
  + модульная система => nginx может расширять свои функции
* Apache главный конкурент
  + больше подходит для динамического контента (генерируется во время запроса клиента и может изменяться от запроса к запросу)
  + сайт может работать на nginx и apache: Nginx принимает все запросы и обрабатывает статический контент, а динамический переправляет Apache
* настройки 
  + `etc/nginx/nginx.conf` глобальные 
  + `/etc/nginx/site-available`, `/etc/nginx/conf.d/` для конкретных сайтов
  + наследует параметры из nginx.conf, но они могут быть переопределены в конкретном виртуальном хосте
* После дефолтной установки nginx есть один виртуальный хост
  + конфиг `default.conf`
  + виртуальный хост = конфигурационный файл
    - настройки в зависимости от _имени домена_
    - описывает настройку одного домена
    - отдельный конфиг
    - `/etc/nginx/conf.d` конфиги с виртуальными хостами 

### Locations
* отвечает за маршрутизацию запросов
  + настройки в зависимости от _URI запроса_
  + ищет совпадения HTTP-запроса с `server_name` и `listen` в контексте server -> ищет совпадения с условиями обработки `location` -> понимает, что отдать клиенту
  + сначала проверяются префиксные строки location в конфигурационном файле, совпадения запоминаются
   - потом проверяются регулярные выражения, проверка прекращается после совпадения
    - если совпадение не было найдено, используется запомненный ранее префикс
  + могут задаваться точным URI, частью URI, регулярным выражением  
* конфигурация разделяется на виртуальные серверы
* для виртуального сервера можно задать адреса, порты, имена
* `/` корень сайта, перехватывает все запросы к домену
* `~ \.php$` запросы к файлам с расширением php
  + если в запросе указан путь к файлу .php, то к нему применяется параметр fastcgi_pass и запрос отправляется на обработку к php-fpm
* могут быть сконфигурированы для обслуживания запросов из статического файла, проксирования на fastcgi/memcached сервер  

### Опция "daemon off" 
* nginx работает в текущем процессе, в переднем плане, как основной процесс в контейнере, позволяя контейнеру оставаться активным
* по умолчанию Nginx в фоновом режиме как демон
  + в контейнерах это приводит к завершению основного процесса контейнера
  + создает дочерние процессы, что усложняет управление контейнером  
* рекомендации по созданию контейнеризированных приложений
  + daemon off 
  + контейнер управляется одним главным процессом
* упрощает управление процессом Nginx внутри контейнера
* легче видеть логи Nginx в консоли для отладки и мониторинга
* Dockerfile: CMD ["nginx", "-g", "daemon off;"]
* docker-compose.yml:
  ```
  services:
    nginx:
      image: nginx:latest
      command: ["nginx", "-g", "daemon off;"]
  ```

### Примеры
* укажем максимальный срок хранения картинок и шрифтов в кэше, отключим для них логирование
  ```
  location ~* ^.+.(js|css|png|jpg|jpeg|gif|ico|woff|woff2|swf|ttf|svg)$ {
    access_log off;
    expires 1y;
  }
  ```
* закроем доступ к директории .git на сайте
  ```
  location ~ /.git {
    return 404;
  }
  ```
* запретим исполнение скриптов в перечисленных директориях
  ```
  location ~* /(images|cache|media|logs|tmp)/.*.(php|pl|py|jsp|asp|sh|cgi)$ {
    return 404;
  }
  ```

### Команды
`systemctl restart nginx` restart nginx  
`nginx -t` проверка конфигурации  
`nginx -T` конфиг  
`nginx -s reload` применить новую конфигурацию nginx без остановки и перезапуска веб сервера  
* будет запущен новый рабочий процесс с новой конфигурацией  
* старые процессы завершатся  
