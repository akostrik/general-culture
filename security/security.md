### Firewall
* **ufw** надстройка над файерволом iptables 
* `shutdown now`

### iptables
* гибкий и надежный фаервол (брандмауэр, межсетевой экран)
* интерфейс управления работой межсетевого экрана netfilter 
* защищает от угроз сети, уязвимостей программного обеспечения
  + защита от внешних вторжений, перенаправления портов, действий с трафиком
  + для домашних компьютеров не актуально
    - они подключены к сети через роутеры и NAT, которые скрывают их от внешней сети
  + для серверов актуально 
* подсистема iptables и Netfilter встроена в ядро
* ufw это упрощённый интерфейс iptables
* сетевые пакеты, проходящие через компьютер, отправляются им или предназначены ему, ядро направляет через фильтр iptables
  + если проверка пройдена, действие
* пакеты: входящие / исходящие / проходящие => в фильтре iptables пакеты делятся на три цепочки:
  + Input - обрабатывает входящие пакеты и подключения (внешний пользователь пытается подключиться по ssh, веб-сайт отправит вам контент по запросу браузера, ...)
  + forward - для проходящих соединений (на маршрутизаторах, если компьютер раздает wifi, ...)
  + output - для исходящих пакетов и соединений (пакеты, созданный при попытке выполнить ping losst.pro, когда вы запускаете браузер и пытаетесь открыть любой сайт, ...)
* содержит пять таблиц:
  + `filter` все действия, типичные для межсетевых экранов
  + `nat` для преобразования сетевых адресов (например, проброс портов)
  + `raw` для настройки пакетов, поэтому они освобождаются от отслеживания // используется в сложных конфигурациях с несколькими маршрутизаторами
  + `mangle` для специальных преобразований пакетов // используется в сложных конфигурациях с несколькими маршрутизаторами
  + `security` в сетевых правилах для Мандатного управления доступом // используется в сложных конфигурациях с несколькими маршрутизаторами
* таблицы состоят из цепочек
* **цепочка** = набор правил, следующих друг за другом в определённом порядке
* таблица filter содержит три встроенные цепочки: INPUT, OUTPUT, FORWARD, активируются в определённые моменты фильтрации пакетов
* таблица nat включает стандартные цепочки PREROUTING, POSTROUTING, OUTPUT
* описание стандартных цепочек других таблиц можно найти в `iptables(8)`
* по умолчанию все цепочки пусты, не содержат каких-либо правил
* вы должны добавить правила в те цепочки, которые собираетесь использовать
* у цепочек также задана политика по умолчанию — обычно ACCEPT
  + её можно изменить на DROP, если вы хотите убедиться, что ни один пакет не проскочит мимо вашего набора правил
  + политика по умолчанию применяется к пакету только после того, как он пройдёт через все существующие правила
* фильтрация пакетов основана на правилах
* **правило** = несколько условий и действия-цели
  + если пакет соответствует всем условиям, то к нему применяется указанное действие
  + например, на какой интерфейс пришёл пакет (eth0, eth1), какого он типа (ICMP, TCP, UDP), на какой порт направляется
* **цель**
  + указывается опцией `-j/--jump`
  + может быть встроеной (built-in): ACCEPT, DROP, QUEUE, RETURN,... - участь пакета решается незамедлительно и обработка пакета в таблице прекращается
  + может быть целью-расширением (extension): REJECT, LOG, ...
    - могут быть завершающими (как встроенные) или незавершающими (как пользовательские цепочки), подробнее см. iptables-extensions(8)
  + может быть переходом на пользовательскую цепочку - пакет проходит через неё, возвращается в исходную цепочку и продолжает со следующего после перехода правила
    - можете добавить собственные цепочки для большей эффективности или удобства, пример создания цепочек можно найти в статье Настройка межсетевого экрана
* вы не можетеотключить iptables остановив сервис обновления правил iptables, подсистема работает на уровне ядра
* `iptables -L` правила брандмауэра iptables
  + понять, какие порты закрыты с его помощью
  + цепочка INPUT отвечает за открытые порты
    - через нее проходят все входящие пакеты
    - политика по умолчанию - ACCEPT = подключение ко всем портам разрешено
  + цепочка OUTPUT
  + цепочка FORWARD
* `iptables -t nat --list`
* `iptables -F` очистить правила, если сделаете что-то не так
* `iptables -I INPUT -p tcp --dport 1924 -j ACCEPT` открыть порт
* https://losst.pro/nastrojka-iptables-dlya-chajnikov
  
```
                               XXXXXXXXXXXXXXXXXX
                             XXX      Сеть      XXX
                                       |
                                       v
+---------------+             +-------------------+
|таблица: filter| <---+       |таблица: nat       |
|цепочка: INPUT |     |       |цепочка: PREROUTING|
+-------+-------+     |       +--------+----------+
        |             |                |
        v             |                v
[локальный процесс]   |         ***************          +----------------+
        |             +-------+  Маршрутизация  +------> |таблица: filter |
        v                       ***************          |цепочка: FORWARD|
 ***************                                         +-------+--------+
  Маршрутизация                                                  |
 ***************                                                 |
        |                                                        |
        v                       ***************                  |
+---------------+     +------>   Маршрутизация   <---------------+
|таблица: nat   |     |         ***************
|цепочка: OUTPUT|     |                +
+------+--------+     |                |
        |             |                v
        v             |      +---------------------+
+---------------+     |      | таблица: nat        |
|таблица: filter| +---+      | цепочка: POSTROUTING|
|цепочка: OUTPUT|            +---------+-----------+
+---------------+                      |
                                       v
                               XXXXXXXXXXXXXXXXXX
                             XXX      Сеть      XXX
                               XXXXXXXXXXXXXXXXXX
```

